@page "/tickerlogs"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.AspNetCore.SignalR.Client
@using TradeMaster6000.Shared
@inject NavigationManager NavigationManager
@implements IAsyncDisposable
@*@attribute [Authorize]*@

@{ if (IsConnected)
    {
        <div class="row">
            <div class="col-lg-12">
                <RadzenDataGrid @ref="logsGrid" AllowFiltering="false" AllowPaging="true" PageSize="20" AllowSorting="false"
                                Data="@logs" TItem="TickerLog">
                    <Columns>
                        <RadzenDataGridColumn Width="300px" TItem="TickerLog" Property="Log" Title="Log" />
                        <RadzenDataGridColumn Width="100px" TItem="TickerLog" Property="LogType" Title="Type" />
                        <RadzenDataGridColumn Width="100px" TItem="TickerLog" Property="Datetime" Title="Date Time" />
                    </Columns>
                </RadzenDataGrid>
            </div>
        </div>
    }
    else
    {
        <h3>Connecting...</h3>
    }
}

@code {
    RadzenDataGrid<TickerLog> logsGrid;
    HubConnection hubConnection;
    IList<TickerLog> logs = new List<TickerLog>();

    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
        .WithUrl(NavigationManager.ToAbsoluteUri("/orderhub"))
        .Build();

        hubConnection.On<List<TickerLog>>("ReceiveTickerLogs", (list) =>
        {
            logs = list;
            StateHasChanged();
        });

        await hubConnection.StartAsync();

        await Task.Run(() => GetTickerLogs()).ConfigureAwait(false);
    }

    private async Task GetTickerLogs()
    {
        while (IsConnected)
        {
            await hubConnection.SendAsync("GetTickerLogs");
            await Task.Delay(1000);
        }
    }

    public bool IsConnected =>
hubConnection.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        await hubConnection.DisposeAsync();
    }
}